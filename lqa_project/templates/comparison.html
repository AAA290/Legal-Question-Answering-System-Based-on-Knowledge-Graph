{% extends "base.html" %}
{% load static %}

{% block title %}智能法律咨询 - 问答对比{% endblock %}

{% block content %}
    <!-- 输入区域 -->
    <div class="input-area mt-4 d-flex" style="background:white; padding:20px; border-radius:16px; box-shadow:0 4px 6px rgba(0,0,0,0.05); border:1px solid #E8F4FF;">
        <input type="text" id="question-input" placeholder="输入您的法律问题..." style="flex:1; padding:14px 20px; border:2px solid #E8F4FF; border-radius:12px; font-size:16px;">
        <button id="submit-btn" style="padding:14px 32px; background:#007AFF; color:white; border:none; border-radius:12px; cursor:pointer; font-weight:600;">
            发送
        </button>
    </div>

    <!-- 对比结果 -->
    <div class="comparison-container mt-4 d-flex" style="display:flex; gap:20px;">
        <!-- AI-1 问答框 -->
        <div class="chat-box card flex-fill" id="chat-box-1">
            <h4 class="chat-title">知识图谱问答模型</h4>
            <div class="chat-content" id="chat-content-1"></div>
        </div>
        <!-- AI-2 问答框 -->
        <div class="chat-box card flex-fill" id="chat-box-2">
            <h4 class="chat-title">gpt-3.5-turbo</h4>
            <div class="chat-content" id="chat-content-2"></div>
        </div>
    </div>
{% endblock %}

{% block extra_script %}
    <script>
        const input = document.getElementById('question-input');
        const submitBtn = document.getElementById('submit-btn');
        const chatBox1 = document.getElementById('chat-content-1');
        const chatBox2 = document.getElementById('chat-content-2');

        // 添加消息函数
        function addMessage(container, isUser, text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'system'}`;
            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            bubble.textContent = text;
            bubble.style.cssText = isUser ?
                "background:#007AFF; color:white; border-radius:20px 20px 4px 20px; padding:14px 20px;" :
                "background:#E8F4FF; color:#2C3E50; border-radius:20px 20px 20px 4px; padding:14px 20px;";
            messageDiv.appendChild(bubble);
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // 提交问题函数
        async function submitQuestion(question) {
            addMessage(chatBox1, true, question);
            addMessage(chatBox2, true, question);

            try {
                const response1 = await fetch('/qa_kgqa/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ "question": question })
                });
                const data1 = await response1.json();
                addMessage(chatBox1, false, data1.answer);
            } catch {
                addMessage(chatBox1, false, '服务器繁忙，请稍后再试。');
            }

            try {
                const response2 = await fetch('/qa_gpt/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ "question": question })
                });
                const data2 = await response2.json();
                addMessage(chatBox2, false, data2.choices[0].message.content);
            } catch {
                addMessage(chatBox2, false, '服务器繁忙，请稍后再试。');
            }
        }


        // 监听提交
        submitBtn.addEventListener('click', () => {
            const question = input.value.trim();
            if (!question) return;
            input.value = '';
            submitQuestion(question);
        });

        // 监听回车
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                submitBtn.click();
            }
        });
    </script>

    <style>
        /* 统一样式 */
        .card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid #E8F4FF;
            display: flex;
            flex-direction: column;
            width: 50%;
            /* 固定高度 */
            height: 500px;
        }
        .chat-content {
            /* 占满剩余高度并滚动 */
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .chat-title {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            color: #007AFF;
            margin-bottom: 10px;
        }

        .message {
            display: flex;
            margin-bottom: 12px;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.system {
            justify-content: flex-start;
        }

        .bubble {
            max-width: 75%;
            word-wrap: break-word;
            font-size: 16px;
        }
    </style>
{% endblock %}
